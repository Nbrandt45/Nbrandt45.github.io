<!DOCTYPE html>
<html>
<script src='https://d3js.org/d3.v7.min.js'></script>
<style>
	body {padding: 20px; }
	svg {margin-top: 20px; }
</style>
<body>

<h1>Olympic Games Medalists</h1>

<div id="narrative">
	<p> This chart shows the olympic medal counts for countries from 1896 to 2024</p>
	<svg id="lineChart" width="1200" height="900"></svg>
	<button onclick="showExplorer()">Explore Data</button>
</div>

<div id="explorer" class="hidden">
	<h2>Explore Olympic Medalists</h2>
	<label for="countrySelect">Country:</label>
	<select id="countrySelect"></select>

	<label for="sportSelect">Sport:</label>
	<select for="sportSelect"></select>

	<table border="1" style="margin-top:20px;">
		<thead>
			<tr><th>Athlete</th><th>Medal</th><th>Year</th></tr>
		</thead>
		<tbody id="medalistTable"></tbody>
	</table>
</div>
	
<script>
let data;

d3.csv("all_olympic_medalists.csv").then(csv => {
data = csv.map(d => ({
	year: +d.year,
	country: d.country?.trim(),
	sport: d.sport?.trim(),
	athlete: d.athlete?.trim(),
	medal: d.medal?.trim()
})).filter(d => d.year && d.country && d.sport);

console.log("Loaded CSV:", data);

const svg = d3.select("#lineChart"),
	width = +svg.attr("width")
	height = +svg.attr("height"),
	margin = {top: 20, right: 20, bottom: 30, left: 50};
	
const years = Array.from(new Set(data.map(d => +d.year))).sort();
const countries = Array.from(new Set(data.map(d => d.country)));
const sports = Array.from(new Set(data.map(d => d.sport))).sort();

const medalCounts = d3.rollup(data,
	v => v.length,
	d => d.country,
	d => +d.year);
	
const x = d3.scaleLinear()
	.domain(d3.extent(years))
	.range([margin.left, width - margin.right]);

const y = d3.scaleLinear()
	.domain([0, d3.max(countries, c =>
	d3.max(years, y => medalCounts.get(c)?.get(y) || 0)
	)]).nice()
	.range([height - margin.bottom, margin.top]);


const line = d3.line()
	.x(d => x(d[0]))
	.y(d => y(d[1]));

svg.append("g")
	.attr("transform", 'translate(0,${height - margin.bottom})')
	.call(d3.axisBottom(x).ticks(years.length).tickFormat(d3.format("d")));

svg.append("g")
	.attr("transform", 'translate(${margin.left},0)')
	.call(d3.axisLeft(y));

const color = d3.scaleOrdinal(d3.schemeCategory10).domain(countries);

for (const country of countries) {
	const countryData = years.map(y => [y, medalCounts.get(country)?.get(y) || 0]);
	svg.append("path")
	.datum(countryData)
	.attr("fill", "none")
	.attr("stroke", color(country))
	.attr("stroke-width", 2)
	.attr("d", line);
}

const countrySelect = d3.select("#countrySelect");
const sportSelect = d3.select("#sportSelect");

countrySelect.selectAll("option")
	.data(countries)
	.enter()
	.append("option")
	.text(d => d);

sportSelect.selectAll("option")
	.data(sports)
	.enter()
	.append("option")
	.text(d => d);
	
function updateTable() {
	const selectedCountry = countrySelect.node().value;
	const selectedSport = sportSelect.node().value;
	const filtered = data.filter(d =>
		d.country === selectedCountry && d.sport === selectedSport
	);
	
	const tbody = d3.select("#medalistTable");
	tbody.selectAll("tr").remove();
	
	tbody.selectAll("tr")
		.data(filtered)
		.enter()
		.append("tr")
		.html(d => '<td>${d.athletes</td><td>${d.medal}</td><td>${d.year}</td>');
	}
	
countrySelect.on("change", updateTable);
sportSelect.on("change", updateTable);
});

function showExplorer() {
	d3.select("#narrative").classed("hidden", true);
	d3.select("#explorer").classed("hidden", false);
}
</script>
</body>
</html>